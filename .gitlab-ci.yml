image: flowee/buildenv:debian

stages:
- build
- test
- deploy

variables:
  HUB_IMG: flowee/hub

#####  Debian stable

build-debian-stable:
  stage: build
  script:
    - mkdir build
    - cd build
    - cmake -Dbuild_tests=true -Denable_wallet=true -DCMAKE_BUILD_TYPE=ReleaseWithDebugInfo -DCMAKE_INSTALL_PREFIX=.. ..
    - echo nproc=`nproc`
    - make univalue leveldb
    - make -j0`nproc` install
  artifacts:
    paths:
    - bin
    - build/testing/*/test_*
    expire_in: 1 hrs

# this fails on gitlab but the same setup passes on my laptop.
# Best idea I have is that its a memory thing. Disable for now.
.test_hub.deb:
  stage: test
  script: testing/test-parallel build/testing/test/test_hub
  dependencies:
  - build-debian-stable

test_utxo.deb:
  stage: test
  script:
    - build/testing/utxo/test_utxo
    - build/testing/streaming-buffers/test_streaming-buffers
  dependencies:
  - build-debian-stable

test_prevector.deb:
  stage: test
  script: build/testing/prevector/test_prevector
  dependencies:
  - build-debian-stable

test_doublespend.deb:
  stage: test
  script: build/testing/doublespend/test_doublespend
  dependencies:
  - build-debian-stable

#####  Static build (Linux)

build-static:
  image: flowee/buildenv:static
  stage: build
  script: build_static
  artifacts:
    paths:
    - bin
    - etc/flowee
    expire_in: 1 hrs

# how to create a .deb file TODO
# https://about.gitlab.com/2016/10/12/automated-debian-package-build-with-gitlab-ci/

flowee-the-hub-linux.zip:
  stage: deploy
  script: for i in bin/*; do strip $i; done
  artifacts:
    name: flowee-the-hub-${CI_COMMIT_SHA}
    paths:
    - bin
    - etc
  dependencies:
  - build-static
  only:
    - master
    - "2018.01"

createHubDocker:
  stage: deploy
  script:
    - docker login -u flowee -p $DOCKER_TOKEN
    - mv bin support/docker/hub
    - docker build --tag=$HUB_IMG:${CI_COMMIT_REF_NAME} support/docker/hub
    - docker image push $HUB_IMG:${CI_COMMIT_REF_NAME}
  image: docker:latest
  services:
    - docker:dind
  dependencies:
    - build-static
  allow_failure: true

##### Build as standard as it gets.

build-debian-nowallet:
  stage: build
  script:
    - mkdir build
    - cd build
    - cmake -Denable_gui=false ..
    - make univalue leveldb
    - make -j0`nproc` all

